name: Build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read

jobs:
  build_linux:
    runs-on: ubuntu-22.04

    steps:
    - name: checkout
      uses: actions/checkout@v4

    - name: Install Qt and system dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          qtbase5-dev \
          qtwebengine5-dev \
          libqwt-qt5-dev \
          libsfml-dev \
          libvlc-dev \
          libvlccore-dev \
          libusb-1.0-0-dev \
          cmake \
          build-essential

    - name: Build and install VLC-Qt
      run: |
        cd /tmp
        git clone --branch 1.1.1 --depth 1 https://github.com/vlc-qt/vlc-qt
        cd vlc-qt
        mkdir build && cd build
        cmake .. \
          -DQT_VERSION=5 \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr/local \
          -DCMAKE_PREFIX_PATH=/usr/lib/x86_64-linux-gnu
        make -j$(nproc)
        sudo make install
        sudo ldconfig

    - name: Create Makefile
      run: |
        export PATH=/usr/lib/qt5/bin:$PATH
        qmake PowerVelo.pro "INCLUDEPATH+=/usr/local/include" "LIBS+=-L/usr/local/lib"
      env:
        QMAKEFEATURES: /usr/share/qt5/mkspecs/features

    - name: Build
      run: |
        export PATH=/usr/lib/qt5/bin:$PATH
        make -j$(nproc)

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux
        path: build/

  build_windows:
    runs-on: windows-latest

    steps:
    - name: MSVC Environment Setup
      uses: ilammy/msvc-dev-cmd@v1

    - name: checkout
      uses: actions/checkout@v4

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '5.15.2'
        modules: 'qtwebengine'

    - name: Download and install VLC-Qt
      # Using 1.1.0 as it is the last release with pre-built Windows MSVC binaries
      run: |
        Invoke-WebRequest -Uri "https://github.com/vlc-qt/vlc-qt/releases/download/1.1.0/VLC-Qt_1.1.0_win64_msvc2015.7z" -OutFile "$env:TEMP\vlcqt.7z"
        7z x "$env:TEMP\vlcqt.7z" -o"C:\vlcqt_temp"
        $vlcqtDir = (Get-ChildItem "C:\vlcqt_temp" -Directory | Select-Object -First 1).FullName
        Move-Item $vlcqtDir "C:\vlcqt"
      shell: powershell

    - name: Download and install SFML
      run: |
        Invoke-WebRequest -Uri "https://www.sfml-dev.org/files/SFML-2.6.1-windows-vc17-64-bit.zip" -OutFile "$env:TEMP\sfml.zip"
        Expand-Archive -Path "$env:TEMP\sfml.zip" -DestinationPath "C:\sfml"
      shell: powershell

    - name: Build QWT
      run: |
        Set-Location ..
        curl.exe -L -o "$env:TEMP\qwt.tar.bz2" "https://sourceforge.net/projects/qwt/files/qwt/6.2.0/qwt-6.2.0.tar.bz2/download"
        7z x "$env:TEMP\qwt.tar.bz2" -o"$env:TEMP" -y
        7z x "$env:TEMP\qwt.tar" -o"." -y
        Rename-Item "qwt-6.2.0" "qwt-src"
        Set-Location "qwt-src"
        qmake qwt.pro "QWT_INSTALL_PREFIX=..\qwt"
        nmake
        nmake install
      shell: powershell

    - name: Create Makefile
      run: |
        $sfmlDir = (Get-ChildItem "C:\sfml" -Directory | Select-Object -First 1).FullName
        $sfmlDirFwd = $sfmlDir -replace '\\','/'
        $kitRoot = "${env:ProgramFiles(x86)}\Windows Kits\10\Lib"
        $kitVersion = (Get-ChildItem $kitRoot | Sort-Object Name -Descending | Select-Object -First 1).Name
        $winkitInstall = "$kitRoot\$kitVersion\um\x64" -replace '\\','/'
        qmake PowerVelo.pro `
          "VLCQT_INSTALL=C:/vlcqt" `
          "SFML_INSTALL=$sfmlDirFwd" `
          "INCLUDEPATH+=..\qwt\include" `
          "WINKIT_INSTALL=$winkitInstall"
      shell: powershell
      env:
        QMAKEFEATURES: ..\qwt\features

    - name: Build
      run: nmake

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows
        path: build\


  build_mac:
    runs-on: macos-latest

    steps:
    - name: checkout
      uses: actions/checkout@v4

    - name: Install Qt and SFML
      run: |
        brew install qt@5 sfml
        echo "$(brew --prefix qt@5)/bin" >> $GITHUB_PATH

    - name: Build and install QWT
      run: |
        cd /tmp
        curl -L -o qwt.tar.bz2 "https://sourceforge.net/projects/qwt/files/qwt/6.2.0/qwt-6.2.0.tar.bz2/download"
        tar -xjf qwt.tar.bz2
        cd qwt-6.2.0
        qmake qwt.pro "QWT_INSTALL_PREFIX=/tmp/qwt"
        make -j$(sysctl -n hw.logicalcpu)
        make install

    - name: Install VLC-Qt
      run: |
        curl -L -o /tmp/VLC-Qt_1.1.0_macos.7z "https://github.com/vlc-qt/vlc-qt/releases/download/1.1.0/VLC-Qt_1.1.0_macos.7z"
        mkdir -p /tmp/vlcqt_temp
        7z x -o/tmp/vlcqt_temp /tmp/VLC-Qt_1.1.0_macos.7z
        # Handle both flat archives and archives with a single root directory
        VLCQT_SRC=$(find /tmp/vlcqt_temp -maxdepth 1 -mindepth 1 -type d | head -n 1)
        mkdir -p /usr/local/opt/vlc-qt
        if [ -n "$VLCQT_SRC" ] && [ -d "$VLCQT_SRC/lib" ]; then
          cp -r "$VLCQT_SRC"/* /usr/local/opt/vlc-qt/
        else
          cp -r /tmp/vlcqt_temp/* /usr/local/opt/vlc-qt/
        fi
        test -d /usr/local/opt/vlc-qt/lib || { echo "VLC-Qt lib directory not found after extraction"; exit 1; }
        mkdir -p /usr/local/include
        ln -sf /usr/local/opt/vlc-qt/lib/VLCQtCore.framework/Headers /usr/local/include/VLCQtCore
        ln -sf /usr/local/opt/vlc-qt/lib/VLCQtWidgets.framework/Headers /usr/local/include/VLCQtWidgets

    - name: Create Makefile
      run: |
        qmake PowerVelo.pro \
          "SFML_INSTALL=$(brew --prefix sfml)"
      env:
        QMAKEFEATURES: /tmp/qwt/features

    - name: Run MakeFile
      run: make

    - name: Bind rpath for Qt frameworks
      run: |
        install_name_tool -add_rpath /usr/local/lib build/release/MaximumTrainer.app/Contents/MacOS/MaximumTrainer
        install_name_tool -add_rpath /usr/local/opt/vlc-qt/lib build/release/MaximumTrainer.app/Contents/MacOS/MaximumTrainer

    - name: upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos
        path: build/
